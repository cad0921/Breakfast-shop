@{
    ViewBag.Title = "Receiving";
}

<div class="receiving-page">
    <h2>訂單接收</h2>

    <section class="receiving-controls">
        <label>
            狀態篩選：
            <select id="statusFilter">
                <option value="Pending">待製作</option>
                <option value="Preparing">製作中</option>
                <option value="Completed">已完成</option>
                <option value="All">全部訂單</option>
            </select>
        </label>
        <label>
            店家篩選：
            <select id="shopFilter">
                <option value="">全部店家</option>
            </select>
        </label>
        <button id="refreshOrders" type="button">重新整理</button>
    </section>

    <div id="ordersContainer" class="orders-container"></div>
    <div id="receivingMessage" class="receiving-message" role="status"></div>
</div>

<style>
    .receiving-page {
        max-width: 1080px;
        margin: 0 auto;
        padding: 2rem 1.5rem 3rem;
        color: #4b2e05;
        background: linear-gradient(135deg, rgba(255, 246, 222, .9), rgba(255, 233, 188, .65));
    }

    .receiving-page h2 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: #9d5c06;
    }

    .receiving-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        background: rgba(255, 255, 255, .9);
        border-radius: 16px;
        border: 1px solid rgba(247, 188, 67, .25);
        box-shadow: 0 10px 20px rgba(249, 181, 49, .15);
    }

    .receiving-controls select,
    .receiving-controls button {
        border-radius: 12px;
        border: 1px solid rgba(247, 188, 67, .35);
        padding: .55rem .9rem;
        font-size: 1rem;
        background: #fffdfa;
        color: #5b3a10;
    }

    .receiving-controls button {
        background: linear-gradient(135deg, #ff9f1c, #ffbf69);
        color: #fff;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: transform .15s ease, box-shadow .15s ease;
    }

    .receiving-controls button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(255, 159, 28, .25);
    }

    .orders-container {
        display: grid;
        gap: 1.25rem;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .order-card {
        background: rgba(255, 255, 255, .94);
        border-radius: 18px;
        padding: 1.25rem 1.4rem;
        box-shadow: 0 12px 24px rgba(249, 181, 49, .18);
        border: 1px solid rgba(247, 188, 67, .2);
        display: flex;
        flex-direction: column;
        gap: .75rem;
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: .75rem;
    }

    .order-header-left {
        display: flex;
        flex-direction: column;
        gap: .35rem;
    }

    .order-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: #5b3a10;
    }

    .shop-pill {
        display: inline-flex;
        align-items: center;
        gap: .25rem;
        font-size: .78rem;
        padding: .2rem .65rem;
        border-radius: 999px;
        background: rgba(255, 210, 150, .45);
        color: #8a4a07;
        font-weight: 600;
    }

    .order-items {
        margin: 0;
        padding-left: 1.25rem;
        color: rgba(75, 46, 5, .85);
    }

    .order-items li {
        margin-bottom: .35rem;
    }

    .order-actions {
        margin-top: .25rem;
        display: flex;
        flex-wrap: wrap;
        gap: .6rem;
    }

    .order-actions button {
        padding: .55rem 1.1rem;
        border-radius: 10px;
        border: none;
        background: rgba(255, 210, 120, .6);
        color: #7d4504;
        font-weight: 600;
        cursor: pointer;
        transition: transform .15s ease, box-shadow .15s ease;
    }

    .order-actions button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(249, 181, 49, .2);
    }

    .empty-state {
        color: rgba(75, 46, 5, .6);
        text-align: center;
        padding: 2rem 1rem;
        background: rgba(255, 255, 255, .8);
        border-radius: 16px;
        border: 1px dashed rgba(247, 188, 67, .4);
    }

    .status-pill {
        padding: 0.2rem 0.7rem;
        border-radius: 999px;
        font-size: 0.875rem;
        background: rgba(255, 199, 120, .35);
        color: #8a4a07;
        font-weight: 600;
    }

    .receiving-message {
        margin-top: 1.5rem;
        min-height: 1.5rem;
        font-weight: 600;
        color: rgba(75, 46, 5, .7);
    }
</style>

@section scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/2.4.3/jquery.signalR.min.js"></script>
    <script>
        (function () {
            const ordersContainer = document.getElementById('ordersContainer');
            const statusFilter = document.getElementById('statusFilter');
            const shopFilter = document.getElementById('shopFilter');
            const refreshButton = document.getElementById('refreshOrders');
            const messageBox = document.getElementById('receivingMessage');
            let refreshTimer = null;
            let signalRConnection = null;
            let signalRHub = null;
            let signalRStarting = false;
            let signalRReconnectHandle = null;
            let signalRBootstrapAttempts = 0;

            const queryParams = new URLSearchParams(window.location.search || '');
            const presetShopId = (() => {
                for (const [key, value] of queryParams.entries()) {
                    if (!value) continue;
                    const normalizedKey = key.trim().toLowerCase();
                    if (normalizedKey === 'id' || normalizedKey === 'shopid') {
                        return value;
                    }
                }
                return '';
            })();
            const hasPresetShop = presetShopId.length > 0;

            const statusLabel = {
                Pending: '待製作',
                Preparing: '製作中',
                Completed: '已完成',
                Cancelled: '已取消'
            };

            function formatHeader(order) {
                if (order.OrderType === 'TakeOut') {
                    return '外帶取餐碼：' + (order.TakeoutCode || '未產生');
                }
                if (order.TableNumber != null) {
                    const zone = order.TableZone ? '（' + order.TableZone + '）' : '';
                    return '內用桌號：' + order.TableNumber + zone;
                }
                return '內用訂單';
            }

            function renderOrders(orders) {
                ordersContainer.innerHTML = '';
                if (!orders || orders.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-state';
                    empty.textContent = '目前沒有訂單。';
                    ordersContainer.appendChild(empty);
                    return;
                }

                orders.forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'order-card';

                    const header = document.createElement('div');
                    header.className = 'order-header';

                    const headerLeft = document.createElement('div');
                    headerLeft.className = 'order-header-left';
                    if (order.ShopName) {
                        const shop = document.createElement('span');
                        shop.className = 'shop-pill';
                        shop.textContent = order.ShopName;
                        headerLeft.appendChild(shop);
                    }
                    const title = document.createElement('div');
                    title.className = 'order-title';
                    title.textContent = formatHeader(order);
                    headerLeft.appendChild(title);
                    header.appendChild(headerLeft);

                    const status = document.createElement('span');
                    status.className = 'status-pill';
                    status.textContent = statusLabel[order.Status] || order.Status;
                    header.appendChild(status);
                    card.appendChild(header);

                    if (order.Notes) {
                        const notes = document.createElement('div');
                        notes.textContent = '備註：' + order.Notes;
                        notes.style.marginBottom = '0.5rem';
                        card.appendChild(notes);
                    }

                    const itemList = document.createElement('ul');
                    itemList.className = 'order-items';
                    order.Items.forEach(item => {
                        const li = document.createElement('li');
                        const subtotal = (item.UnitPrice * item.Quantity).toFixed(0);
                        li.textContent = item.MealName + ' x ' + item.Quantity + ' ($' + subtotal + ')';
                        if (item.Notes) {
                            li.textContent += ' - ' + item.Notes;
                        }
                        itemList.appendChild(li);
                    });
                    card.appendChild(itemList);

                    const actions = document.createElement('div');
                    actions.className = 'order-actions';

                    if (order.Status === 'Pending') {
                        actions.appendChild(createActionButton(order.Id, 'Preparing', '開始製作'));
                    }
                    if (order.Status === 'Pending' || order.Status === 'Preparing') {
                        actions.appendChild(createActionButton(order.Id, 'Completed', '標記完成'));
                    }

                    if (actions.children.length > 0) {
                        card.appendChild(actions);
                    }

                    ordersContainer.appendChild(card);
                });
            }

            function createActionButton(orderId, status, label) {
                const button = document.createElement('button');
                button.type = 'button';
                button.textContent = label;
                button.addEventListener('click', () => updateStatus(orderId, status));
                return button;
            }

            function getActiveShopId() {
                if (hasPresetShop) {
                    return presetShopId;
                }
                if (!shopFilter) {
                    return '';
                }
                return shopFilter.value || '';
            }

            function normalizeGuid(value) {
                return (value || '').toString().trim().toLowerCase();
            }

            function shouldRefreshForShop(payloadShopId) {
                const payloadValue = normalizeGuid(payloadShopId);
                const activeValue = normalizeGuid(getActiveShopId());
                if (!payloadValue || !activeValue) {
                    return true;
                }
                return payloadValue === activeValue;
            }

            function handleOrderChanged(payload) {
                if (!payload || shouldRefreshForShop(payload.shopId)) {
                    if (refreshTimer) {
                        clearInterval(refreshTimer);
                        refreshTimer = null;
                    }
                    fetchOrders();
                    startAutoRefresh();
                }
            }

            function fetchOrders() {
                const status = statusFilter ? statusFilter.value : '';
                const shopId = getActiveShopId();
                const params = new URLSearchParams();
                if (status) params.append('status', status);
                if (shopId) params.append('shopId', shopId);
                const query = params.toString();

                messageBox.textContent = '載入訂單中…';
                fetch('@Url.Action("GetReceivingOrders", "Home")' + (query ? '?' + query : ''))
                    .then(r => r.json())
                    .then(data => {
                        messageBox.textContent = '';
                        renderOrders(data);
                    })
                    .catch(() => {
                        messageBox.textContent = '無法載入訂單，請稍後再試。';
                    });
            }

            function updateStatus(orderId, status) {
                messageBox.textContent = '更新訂單狀態中…';
                fetch('@Url.Action("UpdateOrderStatus", "Home")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ OrderId: orderId, Status: status })
                })
                    .then(async response => {
                        const payload = await response.json();
                        if (!response.ok || !payload.ok) {
                            throw new Error(payload.error || '更新失敗');
                        }
                        messageBox.textContent = '狀態已更新。';
                        fetchOrders();
                    })
                    .catch(err => {
                        messageBox.textContent = err.message;
                    });
            }

            function startAutoRefresh() {
                if (refreshTimer) clearInterval(refreshTimer);
                refreshTimer = setInterval(fetchOrders, 10000);
            }

            function scheduleSignalRReconnect() {
                if (signalRReconnectHandle) {
                    return;
                }
                signalRReconnectHandle = setTimeout(() => {
                    signalRReconnectHandle = null;
                    startSignalR();
                }, 5000);
            }

            function startSignalR() {
                if (signalRStarting || signalRConnection) {
                    return;
                }
                if (!window.jQuery || typeof $.hubConnection !== 'function') {
                    if (signalRBootstrapAttempts < 5) {
                        signalRBootstrapAttempts += 1;
                        setTimeout(startSignalR, 2000);
                    }
                    return;
                }

                signalRConnection = $.hubConnection();
                signalRHub = signalRConnection.createHubProxy('ordersHub');
                signalRHub.on('orderChanged', handleOrderChanged);

                signalRStarting = true;
                signalRConnection.start()
                    .done(() => {
                        signalRStarting = false;
                    })
                    .fail(() => {
                        signalRStarting = false;
                        signalRConnection = null;
                        signalRHub = null;
                        scheduleSignalRReconnect();
                    });

                signalRConnection.disconnected(() => {
                    signalRConnection = null;
                    signalRHub = null;
                    signalRStarting = false;
                    scheduleSignalRReconnect();
                });
            }

            function lockShopFilterIfNeeded() {
                if (!hasPresetShop || !shopFilter) {
                    return;
                }

                const normalizedPreset = presetShopId.toLowerCase();
                let matchedValue = '';
                for (const option of shopFilter.options) {
                    if ((option.value || '').toLowerCase() === normalizedPreset) {
                        matchedValue = option.value;
                        break;
                    }
                }

                if (!matchedValue) {
                    const presetOption = document.createElement('option');
                    presetOption.value = presetShopId;
                    presetOption.textContent = '指定店家';
                    shopFilter.appendChild(presetOption);
                    matchedValue = presetShopId;
                }

                shopFilter.value = matchedValue;
                shopFilter.disabled = true;

                const filterLabel = shopFilter.closest('label');
                if (filterLabel) {
                    filterLabel.title = '此頁面已依網址指定店家';
                }
            }

            function loadShops() {
                if (!shopFilter) {
                    return Promise.resolve();
                }

                return fetch('@Url.Action("GetShop", "Home")?onlyActive=true')
                    .then(r => r.json())
                    .then(data => {
                        shopFilter.innerHTML = '';

                        const allOption = document.createElement('option');
                        allOption.value = '';
                        allOption.textContent = '全部店家';
                        shopFilter.appendChild(allOption);

                        const shopList = Array.isArray(data) ? data : [];
                        shopList.forEach(shop => {
                            if (!shop || !shop.Id) return;
                            const option = document.createElement('option');
                            option.value = shop.Id;
                            option.textContent = shop.Name || '未命名店家';
                            shopFilter.appendChild(option);
                        });

                        lockShopFilterIfNeeded();
                    })
                    .catch(() => {
                        shopFilter.innerHTML = '';
                        const fallback = document.createElement('option');
                        fallback.value = '';
                        fallback.textContent = '全部店家';
                        shopFilter.appendChild(fallback);

                        lockShopFilterIfNeeded();
                    });
            }

            refreshButton.addEventListener('click', () => {
                fetchOrders();
                startAutoRefresh();
            });
            statusFilter.addEventListener('change', () => {
                fetchOrders();
                startAutoRefresh();
            });
            if (shopFilter) {
                shopFilter.addEventListener('change', () => {
                    fetchOrders();
                    startAutoRefresh();
                });
            }

            loadShops()
                .catch(() => { /* ignore load errors, fallback already applied */ })
                .then(() => {
                    fetchOrders();
                    startAutoRefresh();
                    startSignalR();
                });
        })();
    </script>
}
